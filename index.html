<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Energy Games Mini App</title>
    
    <!-- Telegram WebApp Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Monetag SDK Script -->
    <script src='//libtl.com/sdk.js' data-zone='10078019' data-sdk='show_10078019'></script>

    <!-- Google Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

        :root {
            --bg-color: #121212;
            --card-color: #1e1e1e;
            --primary-gradient: linear-gradient(90deg, #F857A6 0%, #FF5858 100%);
            --secondary-color: #4a4a70;
            --text-color: #f0f0f0;
            --text-muted: #888;
            --energy-color: #00f2ea;
            --bomb-color: #FF5858;
            --font-family: 'Poppins', sans-serif;
            --border-radius: 20px;
        }

        /* --- Base & Layout --- */
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* --- Header --- */
        .header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #333;
        }

        .energy-display {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .energy-icon {
            color: var(--energy-color);
            text-shadow: 0 0 10px var(--energy-color);
        }

        /* --- Main Content --- */
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .page {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        .page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .game-card {
            background: var(--card-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid #333;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .game-card h2 { margin-top: 0; }
        .game-card p { color: var(--text-muted); }

        /* --- Bottom Navigation --- */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            background: var(--card-color);
            border-top: 1px solid #333;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.2s;
        }
        .nav-item.active {
            color: var(--energy-color);
        }
        .nav-item .material-symbols-outlined { font-size: 28px; }
        .nav-item span { font-size: 12px; }

        /* --- Game Modals --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: var(--card-color);
            border-radius: var(--border-radius);
            padding: 25px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            border: 1px solid #444;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-content h2 { margin-top: 0; }
        .close-modal-btn {
            position: absolute;
            top: 15px; right: 15px;
            cursor: pointer;
            color: var(--text-muted);
        }
        
        /* --- General Button Style --- */
        .primary-button {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            background: var(--primary-gradient);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(248, 87, 166, 0.3);
        }
        .primary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(248, 87, 166, 0.4);
        }
        .primary-button:disabled {
            filter: grayscale(1);
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* --- Treasure Lock Game --- */
        #lock-icon { font-size: 5rem; color: #aaa; }
        .code-display { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
        .code-digit {
            width: 50px; height: 50px;
            background: #333; border-radius: 10px;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; font-weight: 600;
        }
        .number-pad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .num-button {
            padding: 15px; background: var(--secondary-color);
            border-radius: 10px; cursor: pointer;
        }

        /* --- Energy Grid Game --- */
        #energy-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px; margin: 20px 0; }
        .grid-node {
            aspect-ratio: 1/1; border-radius: 50%; background: var(--secondary-color);
            transition: all 0.2s; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem;
        }
        .grid-node.revealed { background: #555; }
        .grid-node.energy { color: var(--energy-color); }
        .grid-node.bomb { color: var(--bomb-color); }

        /* --- Shake Game --- */
        #shaker-container {
            width: 150px; height: 250px;
            border: 4px solid white;
            border-radius: 20px 20px 10px 10px;
            margin: 20px auto;
            position: relative;
            overflow: hidden;
        }
        #shaker-fill {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: var(--primary-gradient);
            height: 0%; /* Controlled by JS */
            transition: height 0.3s ease;
        }
        #shaker-percent {
            position: relative; z-index: 2;
            font-size: 2rem; font-weight: 700;
            display: flex; justify-content: center; align-items: center;
            height: 100%;
        }

        /* --- Tasks Page --- */
        .task-item {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--card-color); border: 1px solid #333;
            padding: 15px; border-radius: 12px; margin-bottom: 10px;
        }
        .task-item.completed { opacity: 0.5; }
        .task-reward { color: var(--energy-color); font-weight: 600; }
        .task-button {
            padding: 8px 15px; background: var(--primary-gradient);
            border: none; border-radius: 8px; color: white; cursor: pointer;
        }
        .task-button:disabled { filter: grayscale(1); }

    </style>
</head>
<body>

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <h3>Energy Games</h3>
            <div class="energy-display">
                <span class="material-symbols-outlined energy-icon">bolt</span>
                <span id="energy-balance">0</span>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Games Page -->
            <div id="page-games" class="page active">
                <div class="game-card" data-modal="treasure-lock-modal">
                    <span class="material-symbols-outlined" style="font-size: 3rem;">diamond</span>
                    <h2>Treasure Lock</h2>
                    <p>Listen to the clicks and crack the code!</p>
                </div>
                <div class="game-card" data-modal="energy-grid-modal">
                    <span class="material-symbols-outlined" style="font-size: 3rem;">grid_view</span>
                    <h2>Energy Grid</h2>
                    <p>Find energy nodes, but avoid the bombs.</p>
                </div>
                <div class="game-card" data-modal="shake-game-modal">
                    <span class="material-symbols-outlined" style="font-size: 3rem;">vibration</span>
                    <h2>Shake It!</h2>
                    <p>Shake your phone to mix the energy drink.</p>
                </div>
            </div>

            <!-- Tasks Page -->
            <div id="page-tasks" class="page">
                <h2>Daily Tasks</h2>
                <div class="task-item" id="task-ad">
                    <div>
                        <p style="margin:0;">Watch an Ad</p>
                        <small>Get a bonus reward!</small>
                    </div>
                    <div>
                        <span class="task-reward">+100 ⚡️</span>
                        <button class="task-button" id="task-ad-btn">Watch</button>
                    </div>
                </div>
            </div>

            <!-- Wallet Page -->
            <div id="page-wallet" class="page">
                <h2>Wallet</h2>
                <p>Your total energy balance is:</p>
                <h1 style="text-align: center; font-size: 3rem;"><span id="wallet-balance">0</span> ⚡️</h1>
                <button id="reset-btn" class="primary-button" style="background: #555;">Reset All Data</button>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-item active" data-page="games">
                <span class="material-symbols-outlined">stadia_controller</span>
                <span>Games</span>
            </div>
            <div class="nav-item" data-page="tasks">
                <span class="material-symbols-outlined">task_alt</span>
                <span>Tasks</span>
            </div>
            <div class="nav-item" data-page="wallet">
                <span class="material-symbols-outlined">account_balance_wallet</span>
                <span>Wallet</span>
            </div>
        </nav>
    </div>

    <!-- Modals -->
    <!-- Treasure Lock Modal -->
    <div id="treasure-lock-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="material-symbols-outlined close-modal-btn">close</span>
            <span id="lock-icon" class="material-symbols-outlined">lock</span>
            <h2>Treasure Lock</h2>
            <p>Enter the 4-digit code.</p>
            <div class="code-display">
                <div class="code-digit" id="digit-1"></div>
                <div class="code-digit" id="digit-2"></div>
                <div class="code-digit" id="digit-3"></div>
                <div class="code-digit" id="digit-4"></div>
            </div>
            <div class="number-pad" id="treasure-lock-pad">
                <!-- JS will generate buttons -->
            </div>
        </div>
    </div>
    <!-- Energy Grid Modal -->
    <div id="energy-grid-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="material-symbols-outlined close-modal-btn">close</span>
            <h2>Energy Grid</h2>
            <p id="grid-status">Rounds Left: 1. Clicks Left: 15</p>
            <div id="energy-grid"></div>
            <button id="grid-reset-btn" class="primary-button">New Game</button>
        </div>
    </div>
    <!-- Shake Game Modal -->
    <div id="shake-game-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="material-symbols-outlined close-modal-btn">close</span>
            <h2>Shake your phone!</h2>
            <div id="shaker-container">
                <div id="shaker-fill"></div>
                <div id="shaker-percent">0%</div>
            </div>
            <button id="shake-start-btn" class="primary-button">Start</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram.WebApp;
            try { tg.ready(); tg.expand(); } catch (e) { console.warn("Telegram WebApp script failed."); }

            // --- STATE MANAGEMENT ---
            let state = { energy: 0, tasks: { adWatchedToday: false } };
            const saveState = () => localStorage.setItem('energyGameState', JSON.stringify(state));
            const loadState = () => {
                const saved = localStorage.getItem('energyGameState');
                if (saved) { state = JSON.parse(saved); }
                // Daily reset for tasks can be implemented here by checking a saved date
            };

            const addEnergy = (amount, source) => {
                state.energy += amount;
                updateEnergyDisplay();
                saveState();
                if (tg && tg.sendData) {
                    tg.sendData(JSON.stringify({ action: 'add_energy', amount, source, total_energy: state.energy }));
                }
            };

            const updateEnergyDisplay = () => {
                document.getElementById('energy-balance').textContent = state.energy;
                document.getElementById('wallet-balance').textContent = state.energy;
            };

            // --- NAVIGATION ---
            const pages = document.querySelectorAll('.page');
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const pageId = `page-${item.dataset.page}`;
                    
                    navItems.forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                    
                    pages.forEach(page => page.classList.remove('active'));
                    document.getElementById(pageId).classList.add('active');
                });
            });

            // --- MODAL HANDLING ---
            const modals = document.querySelectorAll('.modal-overlay');
            document.querySelectorAll('[data-modal]').forEach(trigger => {
                trigger.addEventListener('click', () => {
                    const modalId = trigger.dataset.modal;
                    document.getElementById(modalId).classList.add('visible');
                });
            });
            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.closest('.modal-overlay').classList.remove('visible');
                });
            });
            modals.forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('visible');
                    }
                });
            });

            // --- GAME LOGIC ---

            // 1. Treasure Lock
            const lockPad = document.getElementById('treasure-lock-pad');
            const codeDigits = [
                document.getElementById('digit-1'),
                document.getElementById('digit-2'),
                document.getElementById('digit-3'),
                document.getElementById('digit-4')
            ];
            const SECRET_CODE = "1730";
            let userInput = "";

            const setupLockGame = () => {
                userInput = "";
                codeDigits.forEach(d => d.textContent = '');
                lockPad.innerHTML = '';
                const nums = [1, 2, 3, 4, 5, 6, 7, 8, 9, 0, 'C', 'OK'];
                nums.forEach(num => {
                    const btn = document.createElement('button');
                    btn.className = 'num-button';
                    btn.textContent = num;
                    btn.onclick = () => handleLockInput(num);
                    lockPad.appendChild(btn);
                });
            };

            const handleLockInput = (num) => {
                if (num === 'C') {
                    userInput = "";
                } else if (num === 'OK') {
                    if (userInput === SECRET_CODE) {
                        alert("Code Correct! +50 Energy!");
                        addEnergy(50, 'Treasure Lock');
                        document.getElementById('treasure-lock-modal').classList.remove('visible');
                    } else {
                        alert("Wrong Code!");
                        userInput = "";
                    }
                } else if (userInput.length < 4) {
                    userInput += num;
                }
                updateLockDisplay();
            };

            const updateLockDisplay = () => {
                for (let i = 0; i < 4; i++) {
                    codeDigits[i].textContent = userInput[i] || '';
                }
            };

            // 2. Energy Grid
            const gridEl = document.getElementById('energy-grid');
            const gridStatusEl = document.getElementById('grid-status');
            const GRID_SIZE = 64; // 8x8
            const BOMB_COUNT = 8;
            let clicksLeft = 15;
            let gridState = [];

            const setupGridGame = () => {
                gridEl.innerHTML = '';
                gridState = new Array(GRID_SIZE).fill({ type: 'empty' });
                clicksLeft = 15;

                // Place bombs
                let bombsPlaced = 0;
                while (bombsPlaced < BOMB_COUNT) {
                    const index = Math.floor(Math.random() * GRID_SIZE);
                    if (gridState[index].type === 'empty') {
                        gridState[index] = { type: 'bomb', revealed: false };
                        bombsPlaced++;
                    }
                }
                // Place energy bolts
                let energyPlaced = 0;
                while (energyPlaced < 5) {
                     const index = Math.floor(Math.random() * GRID_SIZE);
                    if (gridState[index].type === 'empty') {
                        gridState[index] = { type: 'energy', revealed: false };
                        energyPlaced++;
                    }
                }

                for (let i = 0; i < GRID_SIZE; i++) {
                    const node = document.createElement('div');
                    node.className = 'grid-node';
                    node.dataset.index = i;
                    node.onclick = () => handleGridClick(i);
                    gridEl.appendChild(node);
                }
                updateGridStatus();
            };

            const handleGridClick = (index) => {
                if (clicksLeft <= 0 || gridState[index].revealed) return;
                
                clicksLeft--;
                const nodeData = gridState[index];
                nodeData.revealed = true;
                const nodeEl = gridEl.children[index];
                nodeEl.classList.add('revealed');

                if (nodeData.type === 'bomb') {
                    nodeEl.innerHTML = '💣';
                    nodeEl.classList.add('bomb');
                    alert("BOOM! Game Over.");
                    clicksLeft = 0;
                } else if (nodeData.type === 'energy') {
                    nodeEl.innerHTML = '⚡';
                    nodeEl.classList.add('energy');
                    addEnergy(25, 'Energy Grid');
                } else {
                    addEnergy(2, 'Energy Grid');
                }

                if (clicksLeft === 0) {
                    revealGrid();
                }
                updateGridStatus();
            };
            
            const revealGrid = () => {
                for(let i=0; i<GRID_SIZE; i++) {
                    const nodeEl = gridEl.children[i];
                    if(!gridState[i].revealed) {
                        nodeEl.classList.add('revealed');
                        if (gridState[i].type === 'bomb') nodeEl.innerHTML = '💣';
                        if (gridState[i].type === 'energy') nodeEl.innerHTML = '⚡';
                    }
                }
            };
            
            const updateGridStatus = () => gridStatusEl.textContent = `Clicks Left: ${clicksLeft}`;
            document.getElementById('grid-reset-btn').addEventListener('click', setupGridGame);

            // 3. Shake Game
            const shakeStartBtn = document.getElementById('shake-start-btn');
            const shakerFill = document.getElementById('shaker-fill');
            const shakerPercent = document.getElementById('shaker-percent');
            let shakeProgress = 0;
            let motionHandler;

            shakeStartBtn.addEventListener('click', () => {
                // Feature detection
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                startShaking();
                            } else {
                                alert("Permission to access motion sensors was denied.");
                            }
                        })
                        .catch(console.error);
                } else {
                    // Handle non-iOS 13+ devices
                    startShaking();
                }
            });

            const startShaking = () => {
                shakeStartBtn.disabled = true;
                shakeProgress = 0;
                updateShakerDisplay();

                motionHandler = (event) => {
                    const { x, y, z } = event.acceleration;
                    const magnitude = Math.sqrt(x*x + y*y + z*z);
                    if (magnitude > 15) { // Threshold for a decent shake
                        shakeProgress += 2;
                        if(shakeProgress > 100) shakeProgress = 100;
                        updateShakerDisplay();
                    }
                };

                window.addEventListener('devicemotion', motionHandler);

                setTimeout(() => {
                    window.removeEventListener('devicemotion', motionHandler);
                    const energyEarned = Math.floor(shakeProgress * 0.75); // Max 75 energy
                    alert(`Time's up! You earned ${energyEarned} energy.`);
                    addEnergy(energyEarned, 'Shake Game');
                    shakeStartBtn.disabled = false;
                    shakeProgress = 0;
                    updateShakerDisplay();
                }, 7000); // 7 seconds
            };
            
            const updateShakerDisplay = () => {
                shakerFill.style.height = `${shakeProgress}%`;
                shakerPercent.textContent = `${Math.round(shakeProgress)}%`;
            };

            // --- TASKS ---
            const taskAdBtn = document.getElementById('task-ad-btn');
            taskAdBtn.addEventListener('click', () => {
                if (typeof show_10078019 === 'function') {
                    taskAdBtn.disabled = true;
                    show_10078019().then(() => {
                        alert("Thanks for watching! +100 Energy!");
                        addEnergy(100, "Monetag Ad");
                        state.tasks.adWatchedToday = true;
                        updateTaskDisplay();
                        saveState();
                    }).catch(err => {
                        console.error("Monetag ad error:", err);
                        taskAdBtn.disabled = false;
                    });
                } else {
                    alert("Ad SDK not found. Rewarding directly for testing.");
                    addEnergy(100, "Monetag Ad");
                }
            });

            const updateTaskDisplay = () => {
                if (state.tasks.adWatchedToday) {
                    taskAdBtn.textContent = 'Completed';
                    taskAdBtn.disabled = true;
                    document.getElementById('task-ad').classList.add('completed');
                }
            };
            
            // --- WALLET / ADMIN ---
            document.getElementById('reset-btn').addEventListener('click', () => {
                if(confirm("Are you sure you want to reset all data?")) {
                    localStorage.removeItem('energyGameState');
                    state = { energy: 0, tasks: { adWatchedToday: false } };
                    initializeApp();
                }
            });

            // --- INITIALIZATION ---
            const initializeApp = () => {
                loadState();
                updateEnergyDisplay();
                updateTaskDisplay();
                // Setup games
                setupLockGame();
                setupGridGame();
            };
            
            initializeApp();
        });
    </script>
</body>
</html>
